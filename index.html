<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdScenes Organiser</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        :root {
            /* --- THEME: "Pro Studio" --- */
            --bg-body: #F3F4F6;         
            --bg-surface: #FFFFFF;
            --text-main: #111827;    
            --text-muted: #6B7280;  
            --text-light: #9CA3AF;   
            --brand: #2563EB; 
            --brand-glow: rgba(37, 99, 235, 0.15);
            --brand-subtle: #EFF6FF;
            --border: #E5E7EB;
            
            /* Status Colors */
            --s-draft-bg: #F3F4F6; --s-draft-fg: #6B7280;
            --s-wip-bg: #FFFBEB;   --s-wip-fg: #D97706;
            --s-ready-bg: #ECFDF5; --s-ready-fg: #059669;
            --s-posted-bg: #EFF6FF; --s-posted-fg: #2563EB;

            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-float: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.025);
            --shadow-modal: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --ease: cubic-bezier(0.16, 1, 0.3, 1);
        }

        body { font-family: 'Inter', sans-serif; background: var(--bg-body); color: var(--text-main); min-height: 100vh; display: flex; flex-direction: column; overflow-y: scroll; }
        .container { max-width: 1400px; margin: 0 auto; width: 100%; padding: 0 40px; }

        /* --- AUTH LOGIN OVERLAY --- */
        #authOverlay { position: fixed; inset: 0; background: var(--bg-body); z-index: 9999; display: flex; align-items: center; justify-content: center; }
        .auth-box { background: white; padding: 40px; border-radius: 24px; box-shadow: var(--shadow-modal); width: 400px; border: 1px solid var(--border); }
        .auth-logo { font-weight: 800; font-size: 24px; letter-spacing: -0.03em; color: var(--text-main); margin-bottom: 32px; text-align: center; }
        .auth-logo span { color: var(--text-muted); font-weight: 400; }
        .auth-input { width: 100%; padding: 14px 16px; border-radius: 12px; background: #F3F4F6; border: 1px solid transparent; font-size: 15px; margin-bottom: 16px; transition: all 0.2s; }
        .auth-input:focus { background: white; border-color: var(--brand); box-shadow: 0 0 0 4px var(--brand-glow); }
        .auth-btn { width: 100%; padding: 14px; border-radius: 12px; background: var(--text-main); color: white; font-weight: 600; font-size: 15px; cursor: pointer; border: none; transition: all 0.2s; margin-bottom: 12px; }
        .auth-btn:hover { background: #000; transform: translateY(-1px); }
        .auth-switch { text-align: center; font-size: 13px; color: var(--text-muted); cursor: pointer; }
        .auth-switch:hover { color: var(--text-main); }

        /* --- HEADER --- */
        .header { height: 72px; background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(16px); border-bottom: 1px solid rgba(0,0,0,0.06); position: sticky; top: 0; z-index: 100; display: flex; align-items: center; }
        .header-inner { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        .logo { font-weight: 800; font-size: 20px; letter-spacing: -0.03em; color: var(--text-main); cursor: pointer; user-select: none; }
        .logo span { color: var(--text-muted); font-weight: 400; }
        .actions { display: flex; gap: 12px; align-items: center; }

        /* Buttons */
        .btn { height: 38px; padding: 0 16px; border-radius: 10px; font-size: 13px; font-weight: 600; display: inline-flex; align-items: center; gap: 8px; cursor: pointer; transition: all 0.2s var(--ease); border: 1px solid transparent; }
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-ghost:hover { background: rgba(0,0,0,0.04); color: var(--text-main); }
        .btn-primary { background: var(--text-main); color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .btn-primary:hover { background: #000; transform: translateY(-1px); }
        .icon { width: 16px; height: 16px; stroke: currentColor; stroke-width: 2; fill: none; }

        /* --- DASHBOARD --- */
        .main-content { padding-top: 48px; padding-bottom: 80px; }
        .toolbar { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; }
        .page-title { font-size: 26px; font-weight: 700; letter-spacing: -0.03em; color: var(--text-main); }
        .page-sub { font-size: 13px; color: var(--text-muted); margin-top: 4px; }
        .view-switch { background: #E5E7EB; padding: 3px; border-radius: 10px; display: flex; }
        .switch-btn { padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; color: var(--text-muted); cursor: pointer; border: none; background: transparent; }
        .switch-btn.active { background: white; color: var(--text-main); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        /* --- VIEWS --- */
        .view-panel { display: none; animation: fadeIn 0.3s var(--ease); }
        .view-panel.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }

        /* LIST VIEW */
        .data-table { width: 100%; border-collapse: collapse; background: var(--bg-surface); border-radius: 16px; overflow: hidden; box-shadow: var(--shadow-sm); border: 1px solid var(--border); }
        .data-table th { text-align: left; padding: 16px 24px; font-size: 11px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border); background: #F9FAFB; }
        .data-table td { padding: 16px 24px; border-bottom: 1px solid var(--border); font-size: 14px; vertical-align: middle; color: var(--text-main); transition: background 0.15s; }
        .data-table tr:last-child td { border-bottom: none; }
        .data-table tr:hover td { background: #F9FAFB; cursor: pointer; }
        .cell-main { font-weight: 600; color: var(--text-main); margin-bottom: 4px; }
        .cell-sub { font-size: 13px; color: var(--text-muted); max-width: 300px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .status-pill { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; transition: all 0.2s; white-space: nowrap; }
        .status-pill:hover { filter: brightness(0.95); }
        .dot { width: 6px; height: 6px; border-radius: 50%; }

        .asset-btn { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 500; color: var(--brand); background: var(--brand-subtle); padding: 6px 12px; border-radius: 8px; text-decoration: none; transition: all 0.2s; white-space: nowrap; }
        .asset-btn:hover { background: #DBEAFE; }

        /* ROADMAP BOARD */
        .roadmap-container { display: grid; grid-template-columns: repeat(4, 1fr); gap: 24px; overflow-x: auto; padding-bottom: 20px; }
        .roadmap-col { display: flex; flex-direction: column; gap: 16px; }
        .col-header { display: flex; align-items: center; justify-content: space-between; padding-bottom: 12px; border-bottom: 2px solid transparent; margin-bottom: 4px; }
        .col-backlog .col-header { border-color: #E5E7EB; } .col-week .col-header { border-color: #3B82F6; } .col-next .col-header { border-color: #8B5CF6; } .col-future .col-header { border-color: #10B981; }
        .col-title { font-size: 14px; font-weight: 700; color: var(--text-main); text-transform: uppercase; letter-spacing: 0.05em; }
        .col-count { font-size: 12px; font-weight: 600; color: var(--text-light); background: #E5E7EB; padding: 2px 8px; border-radius: 10px; }
        .road-card { background: white; border-radius: 12px; border: 1px solid var(--border); padding: 16px; box-shadow: var(--shadow-sm); cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 10px; }
        .road-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-float); border-color: #D1D5DB; }
        .road-card.no-date { border-style: dashed; } 
        .card-meta { display: flex; justify-content: space-between; align-items: center; font-size: 11px; color: var(--text-muted); font-weight: 600; }
        .card-title { font-size: 14px; font-weight: 600; color: var(--text-main); line-height: 1.4; }
        .card-snippet { font-size: 12px; color: var(--text-muted); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .empty-zone { border: 2px dashed #E5E7EB; border-radius: 12px; height: 100px; display: flex; align-items: center; justify-content: center; color: var(--text-light); font-size: 13px; font-weight: 500; }

        /* CALENDAR VIEW */
        .cal-frame { background: white; border-radius: 20px; border: 1px solid var(--border); padding: 24px; box-shadow: var(--shadow-sm); }
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
        .cal-title { font-size: 18px; font-weight: 700; }
        
        /* THE FIX: minmax(0, 1fr) locks the grid structure and prevents blowout */
        .cal-grid { display: grid; grid-template-columns: repeat(7, minmax(0, 1fr)); width: 100%; border-top: 1px solid var(--border); border-left: 1px solid var(--border); border-radius: 12px; overflow: hidden; }
        .cal-head-cell { background: #F9FAFB; padding: 12px; text-align: center; font-size: 11px; font-weight: 700; color: var(--text-muted); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        
        /* THE FIX: min-width: 0 allows the ellipsis to work inside a grid child */
        .cal-cell { min-width: 0; background: white; min-height: 140px; padding: 10px; cursor: pointer; border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); transition: background 0.1s; display: flex; flex-direction: column; }
        .cal-cell:hover { background: #F9FAFB; }
        .cal-num { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 6px; }
        .cal-cell.today .cal-num { background: var(--text-main); color: white; }
        .cal-event { max-width: 100%; display: block; background: var(--brand-subtle); color: var(--brand); padding: 3px 6px; border-radius: 4px; font-size: 11px; font-weight: 600; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; border-left: 2px solid var(--brand); }

        /* --- MODALS --- */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.3); backdrop-filter: blur(12px); z-index: 500; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.2s; }
        .overlay.active { display: flex; opacity: 1; }
        .modal { background: white; width: 560px; border-radius: 24px; box-shadow: var(--shadow-modal); transform: scale(0.96) translateY(10px); transition: all 0.3s var(--ease); overflow: hidden; display: flex; flex-direction: column; max-height: 85vh; }
        .overlay.active .modal { transform: scale(1) translateY(0); }
        .modal-header { padding: 24px 32px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.9); }
        .modal-title { font-size: 18px; font-weight: 700; color: var(--text-main); letter-spacing: -0.02em; }
        .modal-close { width: 32px; height: 32px; border-radius: 8px; border: none; background: transparent; color: var(--text-light); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .modal-close:hover { background: #F3F4F6; color: var(--text-main); }
        .modal-body { padding: 32px; overflow-y: auto; }
        .field { margin-bottom: 24px; }
        .field-label { display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
        .studio-input { width: 100%; padding: 14px 16px; border-radius: 12px; border: 1px solid transparent; background: #F3F4F6; font-size: 15px; color: var(--text-main); font-family: inherit; font-weight: 500; transition: all 0.2s ease; }
        .studio-input:hover { background: #E5E7EB; }
        .studio-input:focus { background: white; border-color: var(--brand); box-shadow: 0 0 0 4px var(--brand-glow); outline: none; }
        .field-row { display: flex; gap: 20px; }
        .field-col { flex: 1; }
        .modal-foot { padding: 24px 32px; background: #F9FAFB; border-top: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }

        /* Dropdowns */
        .popover { position: absolute; top: calc(100% + 8px); right: 0; background: white; border: 1px solid var(--border); border-radius: 14px; box-shadow: var(--shadow-float); min-width: 220px; padding: 6px; display: none; z-index: 200; }
        .pop-item { padding: 10px 12px; font-size: 13px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; color: var(--text-main); }
        .pop-item:hover { background: #F3F4F6; }
        .toast { position: fixed; bottom: 32px; left: 50%; transform: translate(-50%, 20px); background: var(--text-main); color: white; padding: 10px 24px; border-radius: 50px; font-size: 13px; font-weight: 500; opacity: 0; pointer-events: none; box-shadow: var(--shadow-float); transition: all 0.3s; z-index: 1000; }
        .toast.show { opacity: 1; transform: translate(-50%, 0); }

    </style>
</head>
<body>

    <div id="authOverlay">
        <div class="auth-box">
            <div class="auth-logo">adscenes <span>organiser</span></div>
            <div id="loginForm">
                <input type="email" id="authEmail" class="auth-input" placeholder="Email Address">
                <input type="password" id="authPass" class="auth-input" placeholder="Password">
                <button class="auth-btn" id="authMainBtn" onclick="handleAuth()">Sign In</button>
                <div class="auth-switch" id="authSwitch" onclick="toggleAuthMode()">Need an account? Sign Up</div>
            </div>
            <div id="authError" style="color: #EF4444; font-size: 13px; text-align: center; margin-top: 12px; display: none;"></div>
        </div>
    </div>

    <header class="header">
        <div class="container header-inner">
            <div class="logo" onclick="window.location.reload()">
                adscenes <span>organiser</span>
            </div>
            <div class="actions">
                <div style="position: relative;">
                    <button class="btn btn-ghost" onclick="toggle('clientPop')">
                        <span id="currentClient">All Clients</span>
                        <svg class="icon" viewBox="0 0 24 24" style="margin-left:6px;"><path d="M6 9l6 6 6-6"/></svg>
                    </button>
                    <div id="clientPop" class="popover"></div>
                </div>
                <div style="position: relative;">
                    <button class="btn btn-ghost" onclick="toggle('menuPop')">
                        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                    </button>
                    <div id="menuPop" class="popover">
                        <div class="pop-item" onclick="document.getElementById('file').click()">Import Backup (JSON)</div>
                        <div class="pop-item" onclick="exportData()">Export Backup</div>
                        <div style="height:1px; background:var(--border); margin:4px 0;"></div>
                        <div class="pop-item" style="color:#EF4444;" onclick="logout()">Sign Out</div>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="openModal()">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span>New Post</span>
                </button>
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div class="toolbar">
                <div>
                    <h1 class="page-title">Campaigns</h1>
                    <div class="page-sub" id="subtitle">Loading...</div>
                </div>
                <div class="view-switch">
                    <button class="switch-btn active" onclick="setView('list', this)">List</button>
                    <button class="switch-btn" onclick="setView('roadmap', this)">Board</button>
                    <button class="switch-btn" onclick="setView('cal', this)">Calendar</button>
                </div>
            </div>

            <div id="view-list" class="view-panel active">
                <table class="data-table">
                    <thead><tr><th style="width: 45%;">Details</th><th style="width: 15%;">Status</th><th style="width: 15%;">Client</th><th style="width: 15%;">Asset</th><th style="width: 10%; text-align: right;">Date & Time</th></tr></thead>
                    <tbody id="listBody"></tbody>
                </table>
            </div>

            <div id="view-roadmap" class="view-panel"><div class="roadmap-container" id="roadmapGrid"></div></div>

            <div id="view-cal" class="view-panel">
                <div class="cal-frame">
                    <div class="cal-header">
                        <h2 class="cal-title" id="calTitle">Month</h2>
                        <div style="display:flex; gap:8px;"><button class="btn btn-ghost" onclick="moveMonth(-1)">Prev</button><button class="btn btn-ghost" onclick="resetMonth()">Today</button><button class="btn btn-ghost" onclick="moveMonth(1)">Next</button></div>
                    </div>
                    <div class="cal-grid" id="calGrid"></div>
                </div>
            </div>
        </div>
    </main>

    <div class="overlay" id="editor">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Campaign Details</div>
                <button class="modal-close" onclick="closeModal()"><svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
            </div>
            <div class="modal-body">
                <div class="field">
                    <label class="field-label">Campaign Title</label>
                    <input type="text" id="inpTitle" class="studio-input" placeholder="e.g. Summer Launch v2" autofocus>
                </div>
                
                <div class="field">
                    <div class="field-label">
                        <span>Caption</span>
                        <span id="charCount" style="font-weight:400; color:var(--text-light);">0 chars</span>
                    </div>
                    <textarea id="inpCaption" class="studio-input" rows="4" style="resize:none; line-height:1.5;" placeholder="Write your post copy here..." oninput="updateCount()"></textarea>
                </div>
                
                <div class="field">
                    <label class="field-label">Alt Text (Accessibility)</label>
                    <input type="text" id="inpAlt" class="studio-input" placeholder="Describe the image...">
                </div>

                <div class="field">
                    <label class="field-label">Asset Link (Drive/Figma)</label>
                    <input type="url" id="inpLink" class="studio-input" placeholder="https://...">
                </div>

                <div class="field-row" style="margin-bottom:0;">
                    <div class="field-col">
                        <label class="field-label">Client</label>
                        <select id="inpClient" class="studio-input" style="-webkit-appearance:none; cursor:pointer; background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%2224%22%20height%3D%2224%22%20viewBox%3D%220%200%2024%2024%22%20fill%3D%22none%22%20stroke%3D%22%236B7280%22%20stroke-width%3D%222%22%20stroke-linecap%3D%22round%22%20stroke-linejoin%3D%22round%22%3E%3Cpolyline%20points%3D%226%209%2012%2015%2018%209%22%3E%3C%2Fpolyline%3E%3C%2Fsvg%3E'); background-repeat: no-repeat; background-position: right 12px center; background-size: 16px;"></select>
                    </div>
                    <div class="field-col">
                        <label class="field-label">Schedule Date & Time</label>
                        <input type="datetime-local" id="inpDate" class="studio-input">
                    </div>
                </div>
            </div>
            <div class="modal-foot">
                <button class="btn btn-ghost" style="color:#EF4444;" id="btnDel" onclick="delPost()">Delete</button>
                <div style="display:flex; gap:12px;"><button class="btn btn-ghost" onclick="closeModal()">Cancel</button><button class="btn btn-primary" onclick="saveData()">Save Campaign</button></div>
            </div>
        </div>
    </div>

    <div class="overlay" id="cliModal">
        <div class="modal" style="width: 480px;">
            <div class="modal-header">
                <div class="modal-title">Manage Clients</div>
                <button class="modal-close" onclick="closeModal()">✕</button>
            </div>
            <div class="modal-body">
                <div style="display:flex; gap:12px; margin-bottom:24px;">
                    <input type="text" id="newCliName" class="studio-input" placeholder="New Client Name">
                    <button class="btn btn-primary" onclick="addCli()">Add</button>
                </div>
                <div class="field-label" style="margin-bottom: 12px;">Active Clients (Edit to Rename)</div>
                <div id="cliList" style="max-height:300px; overflow-y:auto; border-top:1px solid var(--border);"></div>
            </div>
            <div class="modal-foot">
                <div style="flex:1"></div>
                <button class="btn btn-primary" onclick="closeModal()">Done</button>
            </div>
        </div>
    </div>

    <div class="toast" id="toast">Saved</div>
    <input type="file" id="file" hidden accept=".json" onchange="importData(event)">

    <script>
        // ==========================================
        // FIREBASE INITIALIZATION
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDvrE92N_kMbIA8gIO0a0dcYx7-ZUmr7mA",
            authDomain: "adscenes-content.firebaseapp.com",
            projectId: "adscenes-content",
            storageBucket: "adscenes-content.firebasestorage.app",
            messagingSenderId: "613616055800",
            appId: "1:613616055800:web:20fcbe7a3370d5b521120d"
        };
        
        if (!firebase.apps.length) { 
            firebase.initializeApp(firebaseConfig); 
        }
        
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==========================================
        // APP STATE
        // ==========================================
        let posts = [];
        let clients = ['Agma Energy', 'ELURA'];
        let filter = 'All Clients';
        let editId = null;
        let cDate = new Date();
        let currentUser = null;
        let isSignup = false;
        let unsubscribe = null;

        // ==========================================
        // AUTHENTICATION ENGINE
        // ==========================================
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                document.getElementById('authOverlay').style.display = 'none';
                loadCloudData();
            } else {
                currentUser = null;
                document.getElementById('authOverlay').style.display = 'flex';
            }
        });

        function toggleAuthMode() {
            isSignup = !isSignup;
            document.getElementById('authMainBtn').innerText = isSignup ? 'Sign Up' : 'Sign In';
            document.getElementById('authSwitch').innerText = isSignup ? 'Already have an account? Sign In' : 'Need an account? Sign Up';
            document.getElementById('authError').style.display = 'none';
        }

        function handleAuth() {
            const email = document.getElementById('authEmail').value;
            const pass = document.getElementById('authPass').value;
            const errBox = document.getElementById('authError');
            
            if (!email || !pass) { 
                errBox.innerText = "Please enter both an email and password."; 
                errBox.style.display = 'block'; 
                return; 
            }

            const promise = isSignup 
                ? auth.createUserWithEmailAndPassword(email, pass)
                : auth.signInWithEmailAndPassword(email, pass);

            promise.catch(e => { 
                let friendlyMessage = "An error occurred. Please try again.";
                let rawError = e.message || "";

                if (e.code === 'auth/user-not-found') {
                    friendlyMessage = "Account doesn't exist. Click 'Sign Up' below.";
                } else if (e.code === 'auth/wrong-password') {
                    friendlyMessage = "Incorrect password. Please try again.";
                } else if (e.code === 'auth/email-already-in-use') {
                    friendlyMessage = "Account already exists. Try signing in instead.";
                } else if (e.code === 'auth/weak-password') {
                    friendlyMessage = "Password is too weak (must be at least 6 characters).";
                } else if (e.code === 'auth/invalid-email') {
                    friendlyMessage = "Please enter a valid email address.";
                } else if (rawError.includes("CONFIGURATION_NOT_FOUND") || e.code === 'auth/operation-not-allowed') {
                    friendlyMessage = "Database locked: Please enable 'Email/Password' in Firebase.";
                } else {
                    friendlyMessage = rawError; 
                }

                errBox.innerText = friendlyMessage; 
                errBox.style.display = 'block'; 
            });
        }

        function logout() { 
            auth.signOut(); 
        }

        // ==========================================
        // CLOUD SYNC ENGINE
        // ==========================================
        function loadCloudData() {
            if (!currentUser) return;
            
            if (unsubscribe) {
                unsubscribe(); 
            }
            
            unsubscribe = db.collection('users').doc(currentUser.uid).onSnapshot((doc) => {
                if (doc.exists) {
                    const data = doc.data();
                    posts = data.posts || [];
                    clients = data.clients || ['Agma Energy', 'ELURA'];
                    render();
                } else {
                    render(); 
                }
            }, (error) => { 
                console.error("Sync Error:", error); 
                toast("Sync Error"); 
            });
        }

        function persist() {
            if (!currentUser) return;
            
            render(); 
            
            db.collection('users').doc(currentUser.uid).set({ 
                posts: posts, 
                clients: clients 
            }).catch(e => { 
                console.error("Save error:", e); 
                toast("Failed to save"); 
            });
        }

        // ==========================================
        // RENDER ENGINE
        // ==========================================
        function render() {
            const visible = filter === 'All Clients' ? posts : posts.filter(p => p.client === filter);
            
            document.getElementById('subtitle').innerText = `${visible.length} Active Campaigns`;
            document.getElementById('currentClient').innerText = filter;

            renderListView(visible);
            renderRoadmap(visible);
            renderCal(visible);
            renderClientDropdown();
        }

        function renderListView(visible) {
            const tbody = document.getElementById('listBody');
            
            if (visible.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:60px; color:var(--text-light);">No campaigns found. Let's create one.</td></tr>`;
            } else {
                tbody.innerHTML = visible.map(p => `
                    <tr onclick="edit('${p.id}')">
                        <td>
                            <div class="cell-main">${esc(p.title)}</div>
                            <div class="cell-sub">${esc(p.caption) || 'No caption'}</div>
                        </td>
                        <td>${getStatusBadge(p)}</td>
                        <td>${esc(p.client)}</td>
                        <td>
                            ${p.link ? `<a href="${p.link}" target="_blank" onclick="event.stopPropagation()" class="asset-btn"><svg class="icon" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg>Asset</a>` : '<span style="color:#E5E7EB">—</span>'}
                        </td>
                        <td style="text-align:right; font-family:'SF Mono', monospace; font-size:12px; color:var(--text-muted);">${formatDate(p.date)}</td>
                    </tr>
                `).join('');
            }
        }

        function renderRoadmap(list) {
            const backlog = [];
            const thisWeek = [];
            const nextWeek = [];
            const future = [];
            
            const today = new Date(); 
            const currentWeekEnd = new Date(today); 
            currentWeekEnd.setDate(today.getDate() + (7 - today.getDay())); 
            
            const nextWeekEnd = new Date(currentWeekEnd); 
            nextWeekEnd.setDate(currentWeekEnd.getDate() + 7);
            
            list.forEach(p => {
                if (!p.date) { 
                    backlog.push(p); 
                    return; 
                }
                const d = new Date(p.date);
                if (d <= currentWeekEnd) {
                    thisWeek.push(p); 
                } else if (d <= nextWeekEnd) {
                    nextWeek.push(p); 
                } else {
                    future.push(p);
                }
            });
            
            const cols = [ 
                { title: "Backlog / Ideas", list: backlog, cls: "col-backlog" }, 
                { title: "This Week", list: thisWeek, cls: "col-week" }, 
                { title: "Next Week", list: nextWeek, cls: "col-next" }, 
                { title: "The Future", list: future, cls: "col-future" } 
            ];
            
            document.getElementById('roadmapGrid').innerHTML = cols.map(col => `
                <div class="roadmap-col ${col.cls}">
                    <div class="col-header">
                        <div class="col-title">${col.title}</div>
                        <div class="col-count">${col.list.length}</div>
                    </div>
                    ${col.list.length ? col.list.map(p => `
                        <div class="road-card ${!p.date ? 'no-date' : ''}" onclick="edit('${p.id}')">
                            <div class="card-meta">
                                <span>${p.date ? formatDate(p.date) : 'No Date'}</span>
                                ${p.status === 'Ready' ? '<span style="color:#059669;">Ready</span>' : ''}
                            </div>
                            <div class="card-title">${esc(p.title)}</div>
                            <div class="card-snippet">${esc(p.caption) || 'No caption'}</div>
                        </div>
                    `).join('') : '<div class="empty-zone">Empty</div>'}
                </div>
            `).join('');
        }

        function renderCal(list) {
            const mNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calTitle').innerText = `${mNames[cDate.getMonth()]} ${cDate.getFullYear()}`;
            
            const y = cDate.getFullYear();
            const m = cDate.getMonth(); 
            const first = new Date(y, m, 1).getDay(); 
            const days = new Date(y, m + 1, 0).getDate(); 
            
            // Generate current date locally to compare against calendar cells
            const tzOffset = (new Date()).getTimezoneOffset() * 60000;
            const todayISO = (new Date(Date.now() - tzOffset)).toISOString().split('T')[0];
            
            let html = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `<div class="cal-head-cell">${d}</div>`).join('');
            
            for (let i = 0; i < first; i++) {
                html += `<div class="cal-cell" style="background:#F9FAFB;"></div>`;
            }
            
            for (let d = 1; d <= days; d++) { 
                const iso = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; 
                // Using startsWith allows it to match datetime strings like '2026-02-23T14:30'
                const has = list.filter(p => p.date && p.date.startsWith(iso)); 
                html += `
                    <div class="cal-cell ${iso === todayISO ? 'today' : ''}" onclick="openModal('${iso}')">
                        <div class="cal-num">${d}</div>
                        ${has.map(p => `<div class="cal-event">${esc(p.title)}</div>`).join('')}
                    </div>
                `; 
            }
            
            document.getElementById('calGrid').innerHTML = html;
        }

        function renderClientDropdown() {
            document.getElementById('clientPop').innerHTML = `
                <div class="pop-item" style="color:var(--brand); font-weight:600;" onclick="setFilter('All Clients')">All Clients</div>
                <div style="height:1px; background:var(--border); margin:4px 0;"></div>
                ${clients.map(c => `<div class="pop-item" onclick="setFilter('${c}')">${c}</div>`).join('')}
                <div style="height:1px; background:var(--border); margin:4px 0;"></div>
                <div class="pop-item" style="color:var(--text-muted);" onclick="openCliModal()">Manage Clients...</div>
            `;
        }

        function getStatusBadge(p) {
            const map = { 
                'Draft': { bg: 'var(--s-draft-bg)', fg: 'var(--s-draft-fg)' }, 
                'WIP': { bg: 'var(--s-wip-bg)', fg: 'var(--s-wip-fg)' }, 
                'Ready': { bg: 'var(--s-ready-bg)', fg: 'var(--s-ready-fg)' }, 
                'Posted': { bg: 'var(--s-posted-bg)', fg: 'var(--s-posted-fg)' } 
            };
            const s = map[p.status || 'Draft'];
            const displayStatus = p.status === 'WIP' ? 'In Progress' : (p.status || 'Draft');
            
            return `
                <div class="status-pill" style="background:${s.bg}; color:${s.fg};" onclick="cycleStatus(event, '${p.id}')">
                    <div class="dot" style="background:${s.fg}"></div>
                    ${displayStatus}
                </div>
            `;
        }

        // ==========================================
        // CLIENT MANAGER
        // ==========================================
        function openCliModal() { 
            document.getElementById('clientPop').style.display = 'none'; 
            document.getElementById('cliModal').classList.add('active'); 
            renderCli(); 
        }

        function renderCli() { 
            document.getElementById('cliList').innerHTML = clients.map((c, i) => `
                <div style="display:flex; justify-content:space-between; align-items:center; padding:8px 0; border-bottom:1px solid #eee;">
                    <input type="text" class="studio-input" style="padding:8px 12px; background:transparent; border:1px solid transparent; width:70%; font-weight:600;" value="${esc(c)}" onchange="renameCli(${i}, this.value)" title="Click to rename">
                    <span style="color:#EF4444; cursor:pointer; font-size:12px; font-weight:600; padding:8px;" onclick="delCli(${i})">Delete</span>
                </div>
            `).join(''); 
        }

        function addCli() { 
            const newName = document.getElementById('newCliName').value.trim(); 
            if (newName && !clients.includes(newName)) { 
                clients.push(newName); 
                persist(); 
                renderCli(); 
                document.getElementById('newCliName').value = ''; 
            }
        }

        function renameCli(idx, newName) {
            newName = newName.trim();
            const oldName = clients[idx];
            
            if (!newName || newName === oldName || clients.includes(newName)) { 
                renderCli(); 
                return; 
            }
            
            clients[idx] = newName;
            
            posts.forEach(p => { 
                if (p.client === oldName) p.client = newName; 
            });
            
            if (filter === oldName) {
                filter = newName;
            }
            
            persist();
            renderCli();
            toast('Client Renamed');
        }

        function delCli(idx) { 
            const name = clients[idx];
            const hasPosts = posts.some(p => p.client === name);
            
            if (hasPosts) { 
                alert(`Cannot delete "${name}" because they have active campaigns. Reassign or delete the campaigns first.`); 
                return; 
            }
            
            if (confirm('Remove client?')) { 
                clients.splice(idx, 1); 
                persist(); 
                renderCli(); 
            } 
        }

        // ==========================================
        // IMPORT / EXPORT ENGINE
        // ==========================================
        function importData(e) { 
            const file = e.target.files[0]; 
            if (!file) return; 
            
            const reader = new FileReader(); 
            reader.onload = (event) => { 
                try { 
                    const data = JSON.parse(event.target.result); 
                    
                    // STRICT APPEND: Posts
                    if (data.posts && Array.isArray(data.posts)) {
                        data.posts.forEach(newPost => {
                            if (!newPost.id) {
                                newPost.id = 'post_' + Date.now() + Math.floor(Math.random() * 1000);
                            }
                            if (!newPost.status) {
                                newPost.status = 'Draft';
                            }
                            posts.push(newPost);
                        });
                    }
                    
                    // STRICT MERGE: Clients
                    if (data.clients && Array.isArray(data.clients)) {
                        data.clients.forEach(newClient => {
                            if (!clients.includes(newClient)) {
                                clients.push(newClient);
                            }
                        });
                    }
                    
                    persist(); 
                    toast('Bulk Import Appended & Synced'); 
                    
                } catch(error) { 
                    console.error("Import Error:", error);
                    alert('Invalid file structure. Ensure it is plain text (.json) and strictly formatted.'); 
                }
            }; 
            reader.readAsText(file); 
            e.target.value = ''; 
        }

        function exportData() { 
            const blob = new Blob([JSON.stringify({ posts, clients })], { type: 'application/json' }); 
            const url = URL.createObjectURL(blob); 
            const anchor = document.createElement('a'); 
            anchor.href = url; 
            anchor.download = 'adscenes_backup.json'; 
            anchor.click(); 
        }

        // ==========================================
        // POST EDITOR & ACTIONS
        // ==========================================
        
        // Helper to format proper local datetime strings for inputs
        function getLocalIsoDatetime(dateObj) {
            const tzOffset = dateObj.getTimezoneOffset() * 60000;
            return (new Date(dateObj - tzOffset)).toISOString().slice(0, 16);
        }

        function openModal(dateStr = null) { 
            editId = null; 
            
            document.getElementById('inpTitle').value = ''; 
            document.getElementById('inpCaption').value = ''; 
            document.getElementById('inpAlt').value = ''; 
            document.getElementById('inpLink').value = ''; 
            
            // Set default date, append T12:00 if clicked directly from a calendar cell (which only passes YYYY-MM-DD)
            let defaultDate = getLocalIsoDatetime(new Date());
            if (dateStr) {
                defaultDate = dateStr + 'T12:00';
            }
            document.getElementById('inpDate').value = defaultDate; 
            
            const sel = document.getElementById('inpClient'); 
            sel.innerHTML = clients.map(c => `<option>${c}</option>`).join(''); 
            
            if (filter !== 'All Clients') {
                sel.value = filter; 
            }
            
            document.getElementById('btnDel').style.display = 'none'; 
            document.getElementById('editor').classList.add('active'); 
            updateCount(); 
        }

        function edit(id) { 
            const p = posts.find(x => x.id === id); 
            if (!p) return; 
            
            editId = id; 
            
            document.getElementById('inpTitle').value = p.title; 
            document.getElementById('inpCaption').value = p.caption || ''; 
            document.getElementById('inpAlt').value = p.alt || ''; 
            document.getElementById('inpLink').value = p.link || ''; 
            
            // Ensure old posts with only 'YYYY-MM-DD' don't break the new datetime-local input format
            let dVal = p.date || '';
            if (dVal && dVal.length === 10) {
                dVal += 'T12:00';
            }
            document.getElementById('inpDate').value = dVal; 
            
            const sel = document.getElementById('inpClient'); 
            sel.innerHTML = clients.map(c => `<option>${c}</option>`).join(''); 
            sel.value = p.client; 
            
            document.getElementById('btnDel').style.display = 'block'; 
            document.getElementById('editor').classList.add('active'); 
            updateCount(); 
        }

        function saveData() { 
            const p = { 
                id: editId || 'post_' + Date.now(), 
                title: document.getElementById('inpTitle').value, 
                caption: document.getElementById('inpCaption').value, 
                alt: document.getElementById('inpAlt').value, 
                link: document.getElementById('inpLink').value, 
                client: document.getElementById('inpClient').value, 
                date: document.getElementById('inpDate').value, 
                status: editId ? posts.find(x => x.id === editId).status : 'Draft' 
            }; 
            
            if (editId) {
                posts[posts.findIndex(x => x.id === editId)] = p; 
            } else {
                posts.push(p); 
            }
            
            closeModal(); 
            persist(); 
            toast('Saved'); 
        }

        function delPost() { 
            if (confirm('Delete?')) { 
                posts = posts.filter(x => x.id !== editId); 
                closeModal(); 
                persist(); 
                toast('Deleted'); 
            } 
        }

        function cycleStatus(e, id) { 
            e.stopPropagation(); 
            
            const idx = posts.findIndex(p => p.id === id); 
            const cycle = ['Draft', 'WIP', 'Ready', 'Posted', 'Draft']; 
            const curr = cycle.indexOf(posts[idx].status || 'Draft'); 
            
            posts[idx].status = cycle[curr + 1]; 
            persist(); 
        }

        // ==========================================
        // UI HELPERS
        // ==========================================
        function toggle(id) { 
            const el = document.getElementById(id); 
            el.style.display = el.style.display === 'block' ? 'none' : 'block'; 
        }

        function closeModal() { 
            document.querySelectorAll('.overlay').forEach(o => o.classList.remove('active')); 
        }

        function setView(viewName, btn) { 
            document.querySelectorAll('.view-panel').forEach(el => el.classList.remove('active')); 
            document.getElementById('view-' + viewName).classList.add('active'); 
            
            document.querySelectorAll('.switch-btn').forEach(b => b.classList.remove('active')); 
            btn.classList.add('active'); 
        }

        function setFilter(clientName) { 
            filter = clientName; 
            render(); 
            document.getElementById('clientPop').style.display = 'none'; 
        }

        function updateCount() { 
            document.getElementById('charCount').textContent = document.getElementById('inpCaption').value.length + ' chars'; 
        }

        function moveMonth(n) { 
            cDate.setMonth(cDate.getMonth() + n); 
            render(); 
        }

        function resetMonth() { 
            cDate = new Date(); 
            render(); 
        }

        function esc(text) { 
            return text ? text.replace(/</g, "&lt;") : ''; 
        }

        function formatDate(dateStr) { 
            if (!dateStr) return 'No Date';
            const d = new Date(dateStr);
            const options = { month: 'short', day: 'numeric' };
            if (dateStr.includes('T')) {
                options.hour = 'numeric';
                options.minute = '2-digit';
            }
            return d.toLocaleDateString('en-US', options); 
        }

        function toast(message) { 
            const t = document.getElementById('toast'); 
            t.textContent = message; 
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 2000); 
        }

        // Global click to close popovers
        window.onclick = (e) => { 
            if (!e.target.closest('.actions')) {
                document.querySelectorAll('.popover').forEach(el => el.style.display = 'none'); 
            }
        };

    </script>
</body>
</html>
