<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdScenes Organiser</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }

        :root {
            /* --- THEME: "Liquid Retina" --- */
            --bg-app: #F5F5F7;         
            --bg-panel: #FFFFFF;
            --bg-hover: #F5F5F7;
            
            --text-main: #1D1D1F;    
            --text-muted: #86868B;  
            --text-light: #AEAEB2;   
            
            --accent: #0066CC; 
            --accent-glow: rgba(0, 102, 204, 0.15);
            --accent-subtle: #E5F0FF;
            
            --border: #D2D2D7;
            --border-light: #E5E5EA;
            
            /* Status Indicators */
            --s-draft: #8E8E93;
            --s-wip: #FF9F0A;
            --s-ready: #30D158;
            --s-posted: #007AFF;

            --shadow-card: 0 4px 12px rgba(0,0,0,0.03);
            --shadow-float: 0 12px 24px rgba(0,0,0,0.06);
            --shadow-pop: 0 20px 40px rgba(0,0,0,0.1);
            
            --anim: cubic-bezier(0.25, 1, 0.5, 1);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-app);
            color: var(--text-main);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-y: scroll;
        }

        .app-container { max-width: 1440px; margin: 0 auto; width: 100%; padding: 0 40px; }

        /* --- NAVIGATION --- */
        .nav-bar {
            height: 70px;
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            position: sticky; top: 0; z-index: 100;
            display: flex; align-items: center;
        }
        
        .nav-content { display: flex; justify-content: space-between; align-items: center; width: 100%; }
        
        .brand { 
            font-weight: 700; font-size: 19px; letter-spacing: -0.03em; 
            color: var(--text-main); cursor: pointer; display: flex; align-items: center; gap: 8px; 
        }
        .brand span { color: var(--text-muted); font-weight: 400; }

        .nav-actions { display: flex; gap: 12px; align-items: center; }

        /* Modern Button Suite */
        .btn {
            height: 38px; padding: 0 16px; border-radius: 10px; font-size: 13px; font-weight: 600;
            display: inline-flex; align-items: center; gap: 6px; cursor: pointer; 
            transition: all 0.2s var(--anim); border: none;
        }
        
        .btn-ghost { background: transparent; color: var(--text-muted); }
        .btn-ghost:hover { background: rgba(0,0,0,0.04); color: var(--text-main); }
        
        .btn-primary { 
            background: var(--text-main); color: white; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,0.2); }

        .icon { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; }

        /* --- DASHBOARD HEADER --- */
        .dashboard-head { padding: 48px 0 32px 0; display: flex; justify-content: space-between; align-items: flex-end; }
        .page-title { font-size: 28px; font-weight: 700; letter-spacing: -0.04em; margin-bottom: 4px; }
        .page-sub { color: var(--text-muted); font-size: 14px; }

        .view-switcher {
            background: #E5E5EA; padding: 3px; border-radius: 10px; display: flex;
        }
        .view-opt {
            padding: 6px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;
            color: var(--text-muted); cursor: pointer; border: none; background: transparent;
        }
        .view-opt.active { background: white; color: var(--text-main); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* --- LIST VIEW --- */
        .content-panel { 
            background: var(--bg-panel); border-radius: 18px; 
            box-shadow: var(--shadow-card); overflow: hidden; 
            border: 1px solid rgba(0,0,0,0.04);
            animation: slideUp 0.4s var(--anim);
        }
        @keyframes slideUp { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }

        .list-table { width: 100%; border-collapse: collapse; }
        
        .list-head th {
            text-align: left; padding: 18px 24px; font-size: 11px; font-weight: 700; 
            color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em;
            border-bottom: 1px solid var(--border-light); background: #FAFAFA;
        }
        
        .list-row td {
            padding: 18px 24px; border-bottom: 1px solid var(--border-light);
            font-size: 14px; color: var(--text-main); vertical-align: middle;
            transition: background 0.15s;
        }
        .list-row:last-child td { border-bottom: none; }
        .list-row:hover td { background: var(--bg-hover); cursor: pointer; }
        
        .row-main { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
        .row-title { font-weight: 600; color: var(--text-main); }
        .row-sub { font-size: 13px; color: var(--text-muted); margin-top: 2px; max-width: 400px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Interactive Elements */
        .status-pill {
            display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px;
            border-radius: 20px; font-size: 12px; font-weight: 500;
            background: white; border: 1px solid var(--border-light); box-shadow: 0 1px 2px rgba(0,0,0,0.02);
            transition: all 0.2s;
        }
        .status-pill:hover { border-color: var(--border); transform: scale(1.02); }
        .dot { width: 8px; height: 8px; border-radius: 50%; box-shadow: 0 0 0 1px rgba(0,0,0,0.05); }

        .asset-link {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 12px; font-weight: 600; color: var(--accent);
            background: var(--accent-subtle); padding: 6px 12px; border-radius: 8px;
            text-decoration: none; transition: all 0.2s;
        }
        .asset-link:hover { background: #D6E4FF; }

        .date-badge {
            font-size: 12px; font-family: 'SF Mono', 'Monaco', monospace; 
            color: var(--text-muted); background: #F2F2F7; padding: 4px 8px; border-radius: 6px;
        }

        /* --- CARDS & CALENDAR (Hidden by default) --- */
        .view-section { display: none; }
        .view-section.active { display: block; }
        
        .card-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 24px; padding-bottom: 60px; }
        .card { background: white; border-radius: 16px; border: 1px solid var(--border-light); padding: 24px; cursor: pointer; transition: all 0.2s; display: flex; flex-direction: column; gap: 12px; }
        .card:hover { transform: translateY(-4px); box-shadow: var(--shadow-float); }

        .cal-wrapper { background: white; border-radius: 24px; padding: 32px; border: 1px solid var(--border-light); box-shadow: var(--shadow-card); }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-light); border: 1px solid var(--border-light); border-radius: 12px; overflow: hidden; margin-top: 20px; }
        .cal-cell { background: white; height: 140px; padding: 12px; transition: 0.1s; cursor: pointer; }
        .cal-cell:hover { background: #FAFAFA; }

        /* --- MODAL --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.2); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            z-index: 900; display: none; align-items: center; justify-content: center;
            opacity: 0; transition: opacity 0.2s;
        }
        .modal-overlay.active { display: flex; opacity: 1; }

        .modal {
            background: white; width: 520px; border-radius: 24px;
            box-shadow: var(--shadow-pop); transform: scale(0.95); 
            transition: transform 0.3s var(--anim); overflow: hidden;
            display: flex; flex-direction: column;
        }
        .modal-overlay.active .modal { transform: scale(1); }

        .modal-content { padding: 32px; }
        .input-group { margin-bottom: 20px; }
        .label { display: block; font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 8px; }
        .input {
            width: 100%; padding: 14px; border-radius: 12px; border: 1px solid transparent;
            background: #F2F2F7; font-size: 15px; color: var(--text-main); font-family: inherit;
            transition: all 0.2s;
        }
        .input:focus { background: white; border-color: var(--accent); box-shadow: 0 0 0 4px var(--accent-glow); }

        .modal-actions {
            padding: 24px 32px; background: #FAFAFA; border-top: 1px solid var(--border-light);
            display: flex; justify-content: space-between; align-items: center;
        }

        /* Dropdowns */
        .popover {
            position: absolute; top: 100%; right: 0; margin-top: 8px;
            background: white; border: 1px solid var(--border-light);
            border-radius: 14px; box-shadow: var(--shadow-float);
            min-width: 200px; padding: 6px; display: none; z-index: 200;
        }
        .pop-item { padding: 10px 12px; font-size: 13px; border-radius: 8px; cursor: pointer; display: flex; justify-content: space-between; }
        .pop-item:hover { background: #F5F5F7; }

    </style>
</head>
<body>

    <div class="nav-bar">
        <div class="app-container nav-content">
            <div class="brand" onclick="window.location.reload()">
                AdScenes <span>Organiser</span>
            </div>
            <div class="nav-actions">
                <div style="position: relative;">
                    <button class="btn btn-ghost" onclick="toggle('clientPop')">
                        <span id="currentClientBtn">All Clients</span>
                        <svg class="icon" viewBox="0 0 24 24" style="width:14px; margin-left:4px;"><path d="M6 9l6 6 6-6"/></svg>
                    </button>
                    <div id="clientPop" class="popover"></div>
                </div>

                <div style="position: relative;">
                    <button class="btn btn-ghost" onclick="toggle('menuPop')">
                        <svg class="icon" viewBox="0 0 24 24"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                    </button>
                    <div id="menuPop" class="popover">
                        <div class="pop-item" onclick="forceRestore()">Find Lost Data (Scan)</div>
                        <div class="pop-item" onclick="exp()">Export Backup</div>
                        <div class="pop-item" style="color:#FF3B30;" onclick="wipe()">Reset Everything</div>
                    </div>
                </div>

                <button class="btn btn-primary" onclick="openModal()">
                    <svg class="icon" viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                    <span>New Post</span>
                </button>
            </div>
        </div>
    </div>

    <div class="app-container">
        
        <div class="dashboard-head">
            <div>
                <h1 class="page-title">Campaigns</h1>
                <div class="page-sub" id="subtitle">Loading...</div>
            </div>
            <div class="view-switcher">
                <button class="view-opt active" onclick="setView('list', this)">List</button>
                <button class="view-opt" onclick="setView('card', this)">Cards</button>
                <button class="view-opt" onclick="setView('cal', this)">Calendar</button>
            </div>
        </div>

        <div id="view-list" class="view-section active">
            <div class="content-panel">
                <table class="list-table">
                    <thead class="list-head">
                        <tr>
                            <th style="width: 45%">Post Details</th>
                            <th style="width: 15%">Status</th>
                            <th style="width: 15%">Client</th>
                            <th style="width: 15%">Asset</th>
                            <th style="width: 10%; text-align: right;">Date</th>
                        </tr>
                    </thead>
                    <tbody id="listBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="view-card" class="view-section">
            <div class="card-grid" id="cardGrid"></div>
        </div>

        <div id="view-cal" class="view-section">
            <div class="cal-wrapper">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="font-size:18px; font-weight:700;" id="calTitle">Month</h2>
                    <div style="display:flex; gap:8px;">
                        <button class="btn btn-ghost" onclick="movMonth(-1)">Prev</button>
                        <button class="btn btn-ghost" onclick="currMonth()">Today</button>
                        <button class="btn btn-ghost" onclick="movMonth(1)">Next</button>
                    </div>
                </div>
                <div class="cal-grid" id="calGrid"></div>
            </div>
        </div>

    </div>

    <div class="modal-overlay" id="editor">
        <div class="modal">
            <div class="modal-content">
                <div class="input-group">
                    <label class="label">Title</label>
                    <input type="text" id="inpTitle" class="input" placeholder="Campaign Name">
                </div>
                <div style="display: flex; gap: 16px;">
                    <div class="input-group" style="flex:1;">
                        <label class="label">Client</label>
                        <select id="inpClient" class="input" style="-webkit-appearance:none; cursor:pointer;"></select>
                    </div>
                    <div class="input-group" style="flex:1;">
                        <label class="label">Date</label>
                        <input type="date" id="inpDate" class="input">
                    </div>
                </div>
                <div class="input-group">
                    <label class="label">Asset Link</label>
                    <input type="text" id="inpLink" class="input" placeholder="Google Drive / Figma URL">
                </div>
                <div class="input-group">
                    <label class="label">Caption</label>
                    <textarea id="inpCaption" class="input" rows="3" style="resize:none;" placeholder="Post copy..."></textarea>
                </div>
                <div class="input-group" style="margin-bottom:0;">
                    <label class="label">Alt Text</label>
                    <input type="text" id="inpAlt" class="input" placeholder="Image description">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-ghost" style="color:#FF3B30;" id="btnDel" onclick="delPost()">Delete</button>
                <div style="display:flex; gap:12px;">
                    <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="save()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="cliModal">
        <div class="modal">
            <div class="modal-content">
                <h3 style="margin-bottom:16px;">Manage Clients</h3>
                <div style="display:flex; gap:8px; margin-bottom:20px;">
                    <input type="text" id="newCliName" class="input" placeholder="Client Name">
                    <button class="btn btn-primary" onclick="addCli()">Add</button>
                </div>
                <div id="cliList" style="max-height:300px; overflow-y:auto;"></div>
            </div>
            <div class="modal-actions">
                <div style="flex:1"></div>
                <button class="btn btn-primary" onclick="closeModal()">Done</button>
            </div>
        </div>
    </div>

    <script>
        // --- CORE SYSTEM (The Phoenix Engine) ---
        const DB = {
            POSTS: 'adscenes_final_posts',
            CLIENTS: 'adscenes_final_clients'
        };

        let posts = [];
        let clients = ['My Brand'];
        let filter = 'All Clients';
        let editId = null;
        let cDate = new Date();

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            try {
                // 1. Try Load
                const p = localStorage.getItem(DB.POSTS);
                const c = localStorage.getItem(DB.CLIENTS);
                
                if (p) posts = JSON.parse(p);
                if (c) clients = JSON.parse(c);

                // 2. DEEP SCAN RECOVERY (The "Data Gone" Fix)
                if (posts.length === 0) {
                    console.log("Starting Deep Scan...");
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        // Look for ANY key that might contain posts
                        if (key.includes('posts') || key.includes('data')) {
                            try {
                                const data = JSON.parse(localStorage.getItem(key));
                                if (Array.isArray(data) && data.length > 0 && data[0].title) {
                                    console.log("Recovered data from:", key);
                                    posts = [...posts, ...data]; // Merge found data
                                }
                            } catch (e) {}
                        }
                    }
                    // Deduplicate based on ID or Title
                    posts = posts.filter((v,i,a)=>a.findIndex(t=>(t.id === v.id))===i);
                    if(posts.length > 0) save(); // Save retrieved data to new DB
                }

                render();
            } catch (err) {
                console.error("Critical Init Error:", err);
                alert("System recovered from a crash. Your data should be safe.");
            }
        });

        // --- DATA OPS ---
        function save() {
            localStorage.setItem(DB.POSTS, JSON.stringify(posts));
            localStorage.setItem(DB.CLIENTS, JSON.stringify(clients));
            render();
        }

        function forceRestore() {
            if(confirm("Start Deep Scan for lost data? This will merge any found posts.")) {
                location.reload(); // The scan runs on load
            }
        }

        // --- RENDERERS ---
        function render() {
            const visible = filter === 'All Clients' ? posts : posts.filter(p => p.client === filter);
            document.getElementById('subtitle').innerText = `${visible.length} Active Campaigns`;
            document.getElementById('currentClientBtn').innerText = filter;

            // 1. LIST
            const listBody = document.getElementById('listBody');
            if(visible.length === 0) {
                listBody.innerHTML = `<tr><td colspan="5" style="text-align:center; padding:60px; color:var(--text-muted);">No campaigns found. Click "New Post" to create.</td></tr>`;
            } else {
                listBody.innerHTML = visible.map(p => `
                    <tr class="list-row" onclick="edit('${p.id}')">
                        <td>
                            <div class="row-main">
                                <div>
                                    <div class="row-title">${esc(p.title)}</div>
                                    <div class="row-sub">${esc(p.caption) || 'No caption provided'}</div>
                                </div>
                            </div>
                        </td>
                        <td>${getStatusPill(p)}</td>
                        <td>${esc(p.client)}</td>
                        <td>
                            ${p.link ? `<a href="${p.link}" target="_blank" onclick="event.stopPropagation()" class="asset-link">
                                <svg class="icon" viewBox="0 0 24 24" style="width:14px;"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path></svg>
                                Asset
                            </a>` : '<span style="color:var(--border); font-size:20px;">â€”</span>'}
                        </td>
                        <td style="text-align:right;"><span class="date-badge">${formatDate(p.date)}</span></td>
                    </tr>
                `).join('');
            }

            // 2. CARDS
            document.getElementById('cardGrid').innerHTML = visible.map(p => `
                <div class="card" onclick="edit('${p.id}')">
                    <div style="display:flex; justify-content:space-between;">
                        <span style="font-size:12px; font-weight:600; color:var(--text-muted);">${esc(p.client)}</span>
                        ${getStatusPill(p)}
                    </div>
                    <div style="font-weight:700; font-size:16px;">${esc(p.title)}</div>
                    <div style="font-size:13px; color:var(--text-muted); flex:1;">${esc(p.caption) || 'No caption'}</div>
                    <div style="border-top:1px solid var(--border-light); padding-top:12px; margin-top:4px; display:flex; justify-content:space-between; align-items:center;">
                         <span class="date-badge">${formatDate(p.date)}</span>
                         ${p.link ? '<svg class="icon" style="color:var(--accent);" viewBox="0 0 24 24"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/></svg>' : ''}
                    </div>
                </div>
            `).join('');

            // 3. CALENDAR
            renderCal(visible);

            // 4. CLIENTS
            document.getElementById('clientPop').innerHTML = `
                <div class="pop-item" style="font-weight:600; color:var(--accent);" onclick="setFilter('All Clients')">All Clients</div>
                <div style="height:1px; background:var(--border-light); margin:4px 0;"></div>
                ${clients.map(c => `<div class="pop-item" onclick="setFilter('${c}')">${c}</div>`).join('')}
                <div style="height:1px; background:var(--border-light); margin:4px 0;"></div>
                <div class="pop-item" style="color:var(--text-muted);" onclick="openCliModal()">Manage Clients...</div>
            `;
        }

        function renderCal(list) {
            const mNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            document.getElementById('calTitle').innerText = `${mNames[cDate.getMonth()]} ${cDate.getFullYear()}`;
            
            const y = cDate.getFullYear(), m = cDate.getMonth();
            const first = new Date(y, m, 1).getDay();
            const days = new Date(y, m + 1, 0).getDate();
            const today = new Date().toISOString().split('T')[0];

            let html = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'].map(d => `<div style="text-align:center; font-size:11px; font-weight:700; color:var(--text-muted); padding:10px;">${d}</div>`).join('');
            
            for(let i=0; i<first; i++) html += `<div></div>`;
            for(let d=1; d<=days; d++) {
                const iso = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const has = list.filter(p => p.date === iso);
                html += `
                    <div class="cal-cell" onclick="openModal('${iso}')" style="${iso===today?'background:#F0F9FF;':''}">
                        <div style="font-size:13px; font-weight:600; margin-bottom:4px; ${iso===today?'color:var(--accent);':''}">${d}</div>
                        ${has.map(p => `<div style="font-size:10px; background:var(--bg-app); padding:2px 4px; border-radius:4px; margin-bottom:2px; overflow:hidden; white-space:nowrap; border-left:2px solid var(--accent);">${esc(p.title)}</div>`).join('')}
                    </div>
                `;
            }
            document.getElementById('calGrid').innerHTML = html;
        }

        // --- HELPERS ---
        function getStatusPill(p) {
            const map = {
                'Draft': ['var(--s-draft)', 'Draft'],
                'WIP': ['var(--s-wip)', 'In Progress'],
                'Ready': ['var(--s-ready)', 'Ready'],
                'Posted': ['var(--s-posted)', 'Posted']
            };
            const s = map[p.status] || map['Draft'];
            return `<div class="status-pill" onclick="cycleStatus(event, '${p.id}')">
                <div class="dot" style="background:${s[0]}"></div>${s[1]}
            </div>`;
        }

        // --- INTERACTIONS ---
        function openModal(dateStr = null) {
            editId = null;
            document.getElementById('inpTitle').value = '';
            document.getElementById('inpLink').value = '';
            document.getElementById('inpCaption').value = '';
            document.getElementById('inpAlt').value = '';
            document.getElementById('inpDate').value = dateStr || new Date().toISOString().split('T')[0];
            
            // Client Select
            const sel = document.getElementById('inpClient');
            sel.innerHTML = clients.map(c => `<option>${c}</option>`).join('');
            if(filter !== 'All Clients') sel.value = filter;

            document.getElementById('btnDel').style.display = 'none';
            document.getElementById('editor').classList.add('active');
        }

        function edit(id) {
            const p = posts.find(x => x.id === id);
            if(!p) return;
            editId = id;
            document.getElementById('inpTitle').value = p.title;
            document.getElementById('inpLink').value = p.link || '';
            document.getElementById('inpCaption').value = p.caption;
            document.getElementById('inpAlt').value = p.alt || '';
            document.getElementById('inpDate').value = p.date;
            
            const sel = document.getElementById('inpClient');
            sel.innerHTML = clients.map(c => `<option>${c}</option>`).join('');
            sel.value = p.client;

            document.getElementById('btnDel').style.display = 'block';
            document.getElementById('editor').classList.add('active');
        }

        function save() {
            const p = {
                id: editId || 'post_' + Date.now(),
                title: document.getElementById('inpTitle').value,
                client: document.getElementById('inpClient').value,
                date: document.getElementById('inpDate').value,
                link: document.getElementById('inpLink').value,
                caption: document.getElementById('inpCaption').value,
                alt: document.getElementById('inpAlt').value,
                status: editId ? posts.find(x=>x.id===editId).status : 'Draft'
            };

            if(editId) {
                const idx = posts.findIndex(x => x.id === editId);
                posts[idx] = p;
            } else {
                posts.push(p);
            }
            closeModal();
            save(); // Ops, recursive name. Calls save() -> persist() actually.
            // Correcting inline to avoid recursion bug
            localStorage.setItem(DB.POSTS, JSON.stringify(posts));
            render();
        }

        function delPost() {
            if(confirm('Delete this campaign?')) {
                posts = posts.filter(x => x.id !== editId);
                closeModal();
                save();
            }
        }

        function cycleStatus(e, id) {
            e.stopPropagation();
            const idx = posts.findIndex(p => p.id === id);
            const cycle = ['Draft', 'WIP', 'Ready', 'Posted', 'Draft'];
            const curr = cycle.indexOf(posts[idx].status || 'Draft');
            posts[idx].status = cycle[curr + 1] || 'Draft';
            save();
        }

        // --- UTILS ---
        function toggle(id) { document.getElementById(id).style.display = document.getElementById(id).style.display === 'block' ? 'none' : 'block'; }
        function closeModal() { document.querySelectorAll('.modal-overlay').forEach(o => o.classList.remove('active')); }
        function setView(v, btn) {
            document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
            document.getElementById('view-'+v).classList.add('active');
            document.querySelectorAll('.view-opt').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
        }
        function setFilter(c) { filter = c; render(); toggle('clientPop'); }
        function openCliModal() { toggle('clientPop'); document.getElementById('cliModal').classList.add('active'); renderCli(); }
        function renderCli() {
            document.getElementById('cliList').innerHTML = clients.map((c,i) => `
                <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee;">
                    <span>${c}</span>
                    <span style="color:red; cursor:pointer;" onclick="delCli(${i})">Delete</span>
                </div>
            `).join('');
        }
        function addCli() { const n=document.getElementById('newCliName').value; if(n){clients.push(n); save(); renderCli(); document.getElementById('newCliName').value='';}}
        function delCli(i) { clients.splice(i,1); save(); renderCli(); }
        
        function esc(t) { return t ? t.replace(/</g, "&lt;") : ''; }
        function formatDate(s) { return new Date(s).toLocaleDateString('en-US', {month:'short', day:'numeric'}); }
        function movMonth(n) { cDate.setMonth(cDate.getMonth()+n); render(); }
        function currMonth() { cDate = new Date(); render(); }

        // Global clicks
        window.onclick = (e) => {
            if (!e.target.matches('.btn') && !e.target.matches('.btn *')) {
                document.querySelectorAll('.popover').forEach(p => p.style.display = 'none');
            }
        }
        
        function exp() { const b = new Blob([JSON.stringify({posts,clients})],{type:'application/json'}); const u=URL.createObjectURL(b); const a=document.createElement('a'); a.href=u; a.download='backup.json'; a.click(); }
        function wipe() { if(confirm('Factory Reset?')) { localStorage.clear(); location.reload(); } }

    </script>
</body>
</html>
